# Surrounding Nitrogen Molecules

This directory contains an example of using DANCE to select molecules with 
single nitrogen to nitrogen bonds. The main purpose of this directory is to
test a fingerprint that compares molecules based off the atoms surrounding 
their nitrogen-nitrogen bonds and the Wiberg bond orders of the bond(s). As
this fingeprint is still being tested and is computationally expensive, it is
not yet meant for larger databases like eMolecules.

## Instructions

### Main Pipeline

#### Dependencies

** You will need a cluster with slurm installed to run most of the steps below.**
Install the following dependencies:
- dance (see https://dance.readthedocs.io)
- openeye (`conda install -c openeye openeye-toolkits` or
  `pip install -i https://pypi.anaconda.org/openeye/simple openeye-toolkits`)
  - We used version 2019.10.2 in particular
- openforcefield (`conda install -c omnia openforcefield`)
  - We used version 0.6.0 in particular
  
Download the SMILES version of eMolecules from:
https://www.emolecules.com/info/plus/download-database

#### Preprocessing

By default, eMolecules contains salts along with the molecules. Run the
following command to generate `emolecules_no_salts.smi`, which has the salts
removed.

```bash
python remove_salts.py emolecules.smi emolecules_no_salts.smi
```

This command should take at most a few minutes to run.

As this file is not yet intended to run on the entirety of emolecules, it 
should be shortened to run quicker allowing for more efficient testing. Run 
the following terminal commands to only utilize the first 1000 molecules of 
the emolecules database.

```bash
tail -n+2 emolecules_no_salts.smi > emolecules_no_first_line.smi
```

```bash
head -n60000 emolecules_no_first_line.smi > nosalt_first1000.smi
```

Finally, create a local results directory and a tmp directory within it:

```bash
mkdir -p results/
```

#### Running the Pipeline

Execute the following command to run the pipeline.

```bash
python surrounding_n_n_pipeline.py --smiles-database nosalt_first60000.smi
```

The final datasets will be found under the newly created results folder. This
command should take only a few seconds to run. To easily read the created OEB
files in a .txt format, run the following command:

```bash
 python oeb_results_to_txt.py results/
```

To generate a file containing a readable text view of every molecule and its fingerprint 
data, run the following command:
```bash
 python get_fingerprint_data.py
```
This command will generate the `fingerprint_data.txt` file which can be found in
the `results` folder. Additionally, this command will generate a file called 
`failed_molecules.txt`, which containts molecules that failed to calculate a Wiberg
bond order value. This will be discussed further in the next section.

#### Results 

This pipeline begins with 60000 emolecules. The selection frequency of 3 
in the configuration for the pipeline allows for 334 potenital molecules to be
recorded in the results. However, after filtering through the first 60000
emolecules, the pipeline results in 166 molecules that were identified to 
have 1 single nitrogen-nitrogen bond. 

These 166 molecules are fingerprinted with by a list of 5 values. The first 
4 values in the list are reserved for atomic numbers of neighboring atoms to
the nitrogen-nitrogen bond(s) found in the given molecule. The remaining 
value in the list is reserved for the Wiberg bond order value of the 
nitrogen-nitrogen bond in the molecule. 

It is likely a molecule's fingerprint data will not have a value for 
every index in the list. This is due to the possibility that the nitrogen-nitrogen 
bond of a molecule may not have 4 neighboring atoms.  

In the instance a molecule is unable to be configured in order to calculate 
its Wiberg bond order, an error message will be printed including the smiles 
string for the molecule. The value of the list set aside for the Wiberg bond
order value will then be replaced with a -1. Currently, some molecules will
display a warning that they failed due to unspecified stereochemistry. This
message can be ignored and a molecule will be known to fail if the message,
"Failed to generate conformer for <molecule>" is displayed. Failed molecules
be found in the `failed_molecules.txt` file generated by the 
`get_fingerprint_data.py` script. 
